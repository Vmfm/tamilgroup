<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üî• Tamil VM Group Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;padding:0;font-family:Arial,sans-serif;background:#000;color:#fff;display:flex;flex-direction:column;align-items:center;}
#loginPage,#chatPage{width:100%;max-width:480px;padding:10px;}
input,select,button{padding:10px;margin:5px 0;width:100%;box-sizing:border-box;}
button{cursor:pointer;}
#userInfo{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;}
#chatBox{background:#111;border-radius:10px;padding:10px;height:70vh;overflow-y:auto;margin-bottom:5px;}
.msg{display:flex;align-items:flex-start;margin:5px 0;gap:5px;}
.msg img{width:32px;height:32px;border-radius:50%;}
.msgContent{max-width:70%;padding:6px 10px;border-radius:12px;word-wrap:break-word;background:#222;}
.msg.self .msgContent{margin-left:auto;background:#0044cc;}
.msg.other .msgContent{background:#333;}
.msgContent button{margin-left:5px;font-size:12px;background:none;color:#fff;border:none;cursor:pointer;}
#typingStatus{font-style:italic;color:#aaa;margin-bottom:5px;}
#inputContainer{display:flex;gap:5px;width:100%;margin-bottom:10px;}
#inputContainer input{flex:1;padding:10px;border-radius:5px;border:none;background:#222;color:#fff;}
#inputContainer button{padding:10px;border:none;border-radius:5px;background:#0044cc;color:#fff;}
#recordBtn{width:40px;}
</style>
</head>
<body>

<!-- Login Page -->
<div id="loginPage">
<h2>Login</h2>
<input type="text" id="username" placeholder="Enter Username" required>
<input type="number" id="age" placeholder="Enter Age" required>
<select id="gender">
<option value="" disabled selected>Select Gender</option>
<option value="Male">Male</option>
<option value="Female">Female</option>
<option value="Other">Other</option>
</select>
<input type="file" id="profilePic" accept="image/*">
<button id="loginBtn" onclick="login()">Join Chat</button>
</div>

<!-- Chat Page -->
<div id="chatPage" style="display:none;">
<div id="userInfo">
  <span id="profileDisplay"></span>
  <button onclick="logout()" style="font-size:12px;padding:5px;">Logout</button>
</div>
<div id="typingStatus"></div>
<div id="chatBox"></div>
<div id="inputContainer">
  <input type="text" id="message" placeholder="Type message..." oninput="userTyping()">
  <button onclick="sendMessage()">Send</button>
  <button id="recordBtn" onclick="toggleRecording()">üé§</button>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const firebaseConfig = {
  apiKey:"AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
  authDomain:"tamil-chat-2d54e.firebaseapp.com",
  databaseURL:"https://tamil-chat-2d54e-default-rtdb.firebaseio.com",
  projectId:"tamil-chat-2d54e",
  storageBucket:"tamil-chat-2d54e.appspot.com",
  messagingSenderId:"804705969240"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let currentUser={};
let typingTimeout;
let blockedUsers=JSON.parse(localStorage.getItem("blockedUsers")||"[]");
let mediaRecorder=null;
let isRecording=false;
let audioChunks=[];

function stringToColor(str){let hash=0;for(let i=0;i<str.length;i++){hash=str.charCodeAt(i)+((hash<<5)-hash);}let h=hash%360;return `hsl(${h},70%,50%)`;}

// Auto-login
window.onload=function(){
  const saved=localStorage.getItem("chatUser");
  if(saved){currentUser=JSON.parse(saved); showChat();}
  else{document.getElementById("loginPage").style.display="block";}
};

function login(){
  const username=document.getElementById("username").value.trim();
  const age=document.getElementById("age").value.trim();
  const gender=document.getElementById("gender").value;
  const file=document.getElementById("profilePic").files[0];
  if(!username||!age||!gender){alert("Fill all fields"); return;}
  if(file){const reader=new FileReader(); reader.onload=e=>saveUser(username,age,gender,e.target.result); reader.readAsDataURL(file);}
  else saveUser(username,age,gender,"");
}

function saveUser(username,age,gender,profilePic){
  currentUser={username,age,gender,profilePic};
  localStorage.setItem("chatUser",JSON.stringify(currentUser));
  const userRef=db.ref("users/"+username);
  userRef.set({username,age,gender,profilePic,online:true});
  userRef.onDisconnect().update({online:false});
  showChat();
}

function showChat(){
  document.getElementById("loginPage").style.display="none";
  document.getElementById("chatPage").style.display="block";
  document.getElementById("profileDisplay").innerHTML=`<b>${currentUser.username}</b> <img src="${currentUser.profilePic||'https://via.placeholder.com/32'}" width="32" height="32" style="border-radius:50%">`;

  db.ref("messages").off();
  db.ref("messages").on("child_added",snap=>{
    const msg=snap.val();
    if(blockedUsers.includes(msg.username)) return;
    let div=document.createElement("div");
    div.className="msg "+(msg.username===currentUser.username?"self":"other");
    if(msg.type==="audio"){
      div.innerHTML=`<img src="${msg.profilePic||'https://via.placeholder.com/32'}">
        <div class="msgContent" style="background:${stringToColor(msg.username)};">
          ${msg.username}: <audio controls src="${msg.audioUrl}"></audio>
          ${msg.username===currentUser.username?`<button onclick="deleteMessage('${snap.key}')">üóëÔ∏è</button>`:""}
          ${msg.username!==currentUser.username?`<button onclick="reportUser('${msg.username}')">üö©</button><button onclick="blockUser('${msg.username}')">‚õî</button>`:""}
        </div>`;
    } else {
      div.innerHTML=`<img src="${msg.profilePic||'https://via.placeholder.com/32'}">
        <div class="msgContent" style="background:${stringToColor(msg.username)};">
          ${msg.username}: ${msg.text} 
          ${msg.username===currentUser.username?`<button onclick="deleteMessage('${snap.key}')">üóëÔ∏è</button>`:""}
          ${msg.username!==currentUser.username?`<button onclick="reportUser('${msg.username}')">üö©</button><button onclick="blockUser('${msg.username}')">‚õî</button>`:""}
        </div>`;
    }
    document.getElementById("chatBox").appendChild(div);
    document.getElementById("chatBox").scrollTop=document.getElementById("chatBox").scrollHeight;
  });

  db.ref("typing").off();
  db.ref("typing").on("value",snap=>{
    const data=snap.val()||{};
    let status="";
    for(const user in data){if(user!==currentUser.username && data[user]) status+=`${user} is typing... `;}
    document.getElementById("typingStatus").innerText=status;
  });
}

function sendMessage(){
  const text=document.getElementById("message").value.trim();
  if(!text) return;
  db.ref("messages").push({username:currentUser.username,age:currentUser.age,gender:currentUser.gender,profilePic:currentUser.profilePic,text,type:"text"});
  document.getElementById("message").value="";
  db.ref("typing/"+currentUser.username).set(false);
}

function logout(){
  db.ref("users/"+currentUser.username).update({online:false});
  db.ref("typing/"+currentUser.username).set(false);
  localStorage.removeItem("chatUser");
  currentUser={};
  document.getElementById("chatPage").style.display="none";
  document.getElementById("loginPage").style.display="block";
}

function userTyping(){
  if(!isRecording) db.ref("typing/"+currentUser.username).set(true);
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>{db.ref("typing/"+currentUser.username).set(false);},2000);
}

// Delete, Report, Block
function deleteMessage(key){db.ref("messages/"+key).remove();}
function reportUser(username){db.ref("reports/"+username).transaction(c=> (c||0)+1);}
function blockUser(username){if(!blockedUsers.includes(username)) blockedUsers.push(username); localStorage.setItem("blockedUsers",JSON.stringify(blockedUsers)); refreshChat();}
function unblockUser(username){blockedUsers=blockedUsers.filter(u=>u!==username); localStorage.setItem("blockedUsers",JSON.stringify(blockedUsers)); refreshChat();}
function refreshChat(){document.getElementById("chatBox").innerHTML=""; db.ref("messages").once("value").then(snap=>{snap.forEach(child=>{const msg=child.val();if(blockedUsers.includes(msg.username)) return; showChat();});});}

// Voice recording
const recordBtn=document.getElementById("recordBtn");
function toggleRecording(){
  if(isRecording){stopRecording();}else{startRecording();}
}
function startRecording(){
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    mediaRecorder=new MediaRecorder(stream);
    audioChunks=[];
    mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
    mediaRecorder.onstop=()=>{
      const audioBlob=new Blob(audioChunks,{type:'audio/webm'});
      const audioUrl=URL.createObjectURL(audioBlob);
      db.ref("messages").push({username:currentUser.username,profilePic:currentUser.profilePic,type:"audio",audioUrl});
      isRecording=false; recordBtn.textContent="üé§"; document.getElementById("message").disabled=false;
    };
    mediaRecorder.start(); isRecording=true; recordBtn.textContent="‚èπÔ∏è"; document.getElementById("message").disabled=true;
    setTimeout(stopRecording,60000);
  });
}
function stopRecording(){if(isRecording && mediaRecorder){mediaRecorder.stop(); isRecording=false; recordBtn.textContent="üé§"; document.getElementById("message").disabled=false;}}
</script>
</body>
</html>
