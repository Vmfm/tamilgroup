<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WhatsApp-style Group Chat</title>
<style>
  :root{--bg:#111b21;--panel:#202c33;--accent:#25d366;--muted:#97a4ab}
  body{margin:0;background:var(--bg);color:#e9edef;font-family:Arial,system-ui;min-height:100vh;display:flex;flex-direction:column}
  #app{max-width:900px;margin:0 auto;width:100%;height:100vh;display:flex;flex-direction:column}
  #topBar{padding:8px 12px;background:#0b141a;display:flex;align-items:center;gap:12px}
  #title{font-weight:600}
  #messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;background:#071215}
  .msg-row{display:flex;align-items:flex-end;max-width:80%;position:relative}
  .msg-row.self{align-self:flex-end;flex-direction:row-reverse}
  .avatar{width:34px;height:34px;border-radius:50%;background:#000;color:#fff;
    display:flex;align-items:center;justify-content:center;font-weight:700;margin:0 8px;position:relative;cursor:pointer;
    border:2px solid transparent;transition:border .2s ease-in-out;}
  .avatar.online{border:2px solid #25d366;box-shadow:0 0 0 0 rgba(37,211,102,.7);animation:pulse 1.5s infinite;}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(37,211,102,.7);}70%{box-shadow:0 0 0 6px rgba(37,211,102,0);}100%{box-shadow:0 0 0 0 rgba(37,211,102,0);}}
  .popup-menu{display:none;position:absolute;top:-44px;left:0;background:var(--panel);border-radius:8px;padding:6px;flex-direction:column;z-index:30;min-width:110px}
  .avatar:hover .popup-menu{display:flex}
  .popup-menu button{background:none;border:0;color:#fff;padding:6px 8px;text-align:left;cursor:pointer;border-radius:6px}
  .bubble{background:var(--panel);padding:8px 12px;border-radius:12px;font-size:14px;line-height:1.3;word-break:break-word}
  .msg-row.self .bubble{background:#005c4b}
  .meta{font-size:12px;color:#53bdeb;margin-bottom:4px;display:flex;align-items:center;gap:8px}
  .time{font-size:11px;color:var(--muted);margin-top:6px;text-align:right}
  #inputBar{display:flex;padding:10px;background:var(--panel);align-items:center;gap:8px}
  #messageInput{flex:1;padding:10px;border-radius:22px;border:0;background:#2a3942;color:#fff;outline:none;font-size:14px}
  #sendBtn{width:44px;height:44px;border-radius:50%;border:0;background:var(--accent);color:#fff;font-size:18px;cursor:pointer}
  #statusLine{padding:6px 12px;font-size:13px;color:var(--muted);background:#071215;text-align:center}
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#2a3942;color:#fff;padding:10px 14px;border-radius:10px;z-index:999;opacity:0;transition:opacity .25s,bottom .25s}
  #toast.show{opacity:1;bottom:40px}
  #loginWrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:999}
  #loginCard{background:#0b141a;padding:20px;border-radius:12px;display:flex;flex-direction:column;gap:10px;min-width:260px}
  #loginCard input{padding:10px;border-radius:10px;border:0;background:#162027;color:#fff}
  #loginCard button{padding:10px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  @media(max-width:640px){#app{height:100vh}}
</style>
</head>
<body>
<div id="app">
  <div id="topBar">
    <div id="title">Group Chat</div>
    <div style="flex:1"></div>
    <div id="chatMode" style="font-size:13px;color:var(--muted)"></div>
    <div id="onlineCount" style="color:var(--muted);font-size:13px"></div>
  </div>

  <div id="statusLine"></div>
  <div id="messages" aria-live="polite"></div>

  <div id="inputBar">
    <input id="messageInput" placeholder="Type a message" autocomplete="off"/>
    <button id="sendBtn">‚úàÔ∏è</button>
  </div>
</div>

<div id="toast"></div>
<div id="loginWrap" style="display:none">
  <div id="loginCard">
    <div style="font-weight:700;color:#fff">Enter your name</div>
    <input id="nameInput" placeholder="Your name" />
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="joinBtn">Join</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
  authDomain: "tamil-chat-2d54e.firebaseapp.com",
  databaseURL: "https://tamil-chat-2d54e-default-rtdb.firebaseio.com",
  projectId: "tamil-chat-2d54e",
  storageBucket: "tamil-chat-2d54e.appspot.com",
  messagingSenderId: "804705969240",
  appId: "1:804705969240:web:658df281dd8360843c162d"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

const messagesEl=document.getElementById('messages');
const messageInput=document.getElementById('messageInput');
const sendBtn=document.getElementById('sendBtn');
const toastEl=document.getElementById('toast');
const loginWrap=document.getElementById('loginWrap');
const nameInput=document.getElementById('nameInput');
const joinBtn=document.getElementById('joinBtn');
const chatModeEl=document.getElementById('chatMode');

let username=localStorage.getItem('guestName')||'';
let chatMode='group'; // group or private
let privateWith=null;

function showToast(msg){toastEl.textContent=msg;toastEl.classList.add('show');setTimeout(()=>toastEl.classList.remove('show'),2000);}
function formatTime(ms){const d=new Date(ms);let h=d.getHours(),m=d.getMinutes().toString().padStart(2,'0');const a=h>=12?'PM':'AM';h=h%12||12;return `${h}:${m} ${a}`;}
function scrollBottom(){setTimeout(()=>messagesEl.scrollTop=messagesEl.scrollHeight,100);}

function showLogin(){loginWrap.style.display='flex';}
function hideLogin(){loginWrap.style.display='none';}
if(!username){showLogin();}else{startAs(username);}
joinBtn.onclick=()=>{const v=nameInput.value.trim();if(!v)return showToast('Enter name');username=v;localStorage.setItem('guestName',v);hideLogin();startAs(v);};

function renderMessage(msg){
  if(msg.hidden) return;
  const isSelf=msg.name===username;
  const row=document.createElement('div');row.className='msg-row'+(isSelf?' self':'');
  const avatar=document.createElement('div');avatar.className='avatar';avatar.textContent=msg.name[0].toUpperCase();

  const popup=document.createElement('div');popup.className='popup-menu';
  if(!isSelf){
    const priv=document.createElement('button');priv.textContent='üí¨ Private Chat';
    priv.onclick=()=>startPrivateChat(msg.name);
    popup.appendChild(priv);
  }
  avatar.appendChild(popup);

  const content=document.createElement('div');content.style.display='flex';content.style.flexDirection='column';
  const meta=document.createElement('div');meta.className='meta';meta.textContent=msg.name;
  const bubble=document.createElement('div');bubble.className='bubble';bubble.textContent=msg.text;
  const time=document.createElement('div');time.className='time';time.textContent=formatTime(msg.time);
  content.append(meta,bubble,time);
  row.append(avatar,content);
  messagesEl.appendChild(row);
  scrollBottom();
}

function listenMessages(){
  messagesEl.innerHTML='';
  let ref=chatMode==='group'?db.ref('messages').limitToLast(50):db.ref(`privateChats/${privateWith}/${username}`).limitToLast(10);
  ref.on('child_added',s=>{renderMessage(s.val());});
}

function sendMessage(){
  const text=messageInput.value.trim();if(!text)return;
  const data={name:username,text,time:Date.now()};
  if(chatMode==='group'){
    db.ref('messages').push(data);
  }else{
    db.ref(`privateChats/${username}/${privateWith}`).push(data);
    db.ref(`privateChats/${privateWith}/${username}`).push(data);
    cleanupPrivate(10,username,privateWith);
    cleanupPrivate(10,privateWith,username);
  }
  messageInput.value='';
}

function cleanupPrivate(limit,u1,u2){
  db.ref(`privateChats/${u1}/${u2}`).once('value').then(s=>{
    const v=s.val()||{};const k=Object.keys(v);
    if(k.length>limit){const sorted=k.map(x=>({x,t:v[x].time})).sort((a,b)=>a.t-b.t);
      sorted.slice(0,k.length-limit).forEach(i=>db.ref(`privateChats/${u1}/${u2}/${i.x}`).remove());
    }
  });
}

function startPrivateChat(user){
  privateWith=user;chatMode='private';
  chatModeEl.textContent=`Private with ${user}`;
  messagesEl.innerHTML='';
  listenMessages();
  showToast(`Private chat with ${user}`);
}

function startAs(name){
  chatMode='group';chatModeEl.textContent='Group Chat';
  listenMessages();
}
sendBtn.onclick=sendMessage;
messageInput.onkeypress=e=>{if(e.key==='Enter')sendMessage();}
</script>
</body>
</html>
