<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WhatsApp-style Group Chat</title>
<style>
  :root{--bg:#111b21;--panel:#202c33;--accent:#25d366;--muted:#97a4ab}
  body{margin:0;background:var(--bg);color:#e9edef;font-family:Arial,system-ui;min-height:100vh;display:flex;flex-direction:column}
  #app{max-width:900px;margin:0 auto;width:100%;height:100vh;display:flex;flex-direction:column}
  #topBar{padding:8px 12px;background:#0b141a;display:flex;align-items:center;gap:12px}
  #title{font-weight:600}
  #messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;background:#071215}
  .msg-row{display:flex;align-items:flex-end;max-width:80%;position:relative}
  .msg-row.self{align-self:flex-end;flex-direction:row-reverse}

  .avatar{
    width:34px;height:34px;border-radius:50%;background:#000;color:#fff;
    display:flex;align-items:center;justify-content:center;font-weight:700;margin:0 8px;position:relative;cursor:pointer;
    border: 2px solid transparent;
    transition: border 0.2s ease-in-out;
  }
  .avatar.online{
    border: 2px solid #25d366;
    box-shadow: 0 0 0 0 rgba(37,211,102,0.7);
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse{
    0% { box-shadow: 0 0 0 0 rgba(37,211,102,0.7); }
    70% { box-shadow: 0 0 0 6px rgba(37,211,102,0); }
    100% { box-shadow: 0 0 0 0 rgba(37,211,102,0); }
  }

  .popup-menu{display:none;position:absolute;top:-44px;left:0;background:var(--panel);border-radius:8px;padding:6px;flex-direction:column;z-index:30;min-width:110px}
  .avatar:hover .popup-menu{display:flex}
  .popup-menu button{background:none;border:0;color:#fff;padding:6px 8px;text-align:left;cursor:pointer;border-radius:6px}
  .bubble{background:var(--panel);padding:8px 12px;border-radius:12px;font-size:14px;line-height:1.3;word-break:break-word}
  .msg-row.self .bubble{background:#005c4b}
  .meta{font-size:12px;color:#53bdeb;margin-bottom:4px;display:flex;align-items:center;gap:8px}
  .time{font-size:11px;color:var(--muted);margin-top:6px;text-align:right}
  #inputBar{display:flex;padding:10px;background:var(--panel);align-items:center;gap:8px}
  #messageInput{flex:1;padding:10px;border-radius:22px;border:0;background:#2a3942;color:#fff;outline:none;font-size:14px}
  #sendBtn{width:44px;height:44px;border-radius:50%;border:0;background:var(--accent);color:#fff;font-size:18px;cursor:pointer}
  #statusLine{padding:6px 12px;font-size:13px;color:var(--muted);background:#071215}
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#2a3942;color:#fff;padding:10px 14px;border-radius:10px;z-index:999;opacity:0;transition:opacity .25s,bottom .25s}
  #toast.show{opacity:1;bottom:40px}
  #loginWrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:999}
  #loginCard{background:#0b141a;padding:20px;border-radius:12px;display:flex;flex-direction:column;gap:10px;min-width:260px}
  #loginCard input{padding:10px;border-radius:10px;border:0;background:#162027;color:#fff}
  #loginCard button{padding:10px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer}

  /* Private chat popup */
  #privatePopup{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:var(--bg);display:none;flex-direction:column;z-index:1000;
  }
  #privateHeader{
    background:#0b141a;padding:10px;display:flex;align-items:center;gap:8px;
  }
  #privateHeader button{background:none;border:0;color:#25d366;font-size:16px;cursor:pointer}
  #privateMessages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;background:#071215}
  #privateInputBar{display:flex;padding:10px;background:var(--panel);align-items:center;gap:8px}
  #privateInput{flex:1;padding:10px;border-radius:22px;border:0;background:#2a3942;color:#fff;outline:none;font-size:14px}
  #privateSend{width:44px;height:44px;border-radius:50%;border:0;background:var(--accent);color:#fff;font-size:18px;cursor:pointer}
</style>
</head>
<body>
<div id="app">
  <div id="topBar">
    <div id="title">Group Chat</div>
    <div style="flex:1"></div>
    <div id="onlineCount" style="color:var(--muted);font-size:13px"></div>
  </div>

  <div id="statusLine"></div>
  <div id="messages"></div>

  <div id="inputBar">
    <input id="messageInput" placeholder="Type a message" autocomplete="off"/>
    <button id="sendBtn">✈️</button>
  </div>
</div>

<div id="toast"></div>

<!-- Private chat popup -->
<div id="privatePopup">
  <div id="privateHeader">
    <button id="backToGroup">⬅</button>
    <div id="privateTitle" style="font-weight:600;color:#fff">Private Chat</div>
  </div>
  <div id="privateMessages"></div>
  <div id="privateInputBar">
    <input id="privateInput" placeholder="Type privately..." autocomplete="off"/>
    <button id="privateSend">✈️</button>
  </div>
</div>

<div id="loginWrap" style="display:none">
  <div id="loginCard">
    <div style="font-weight:700;color:#fff">Enter your name</div>
    <input id="nameInput" placeholder="Your name" />
    <button id="joinBtn">Join</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
  authDomain: "tamil-chat-2d54e.firebaseapp.com",
  databaseURL: "https://tamil-chat-2d54e-default-rtdb.firebaseio.com",
  projectId: "tamil-chat-2d54e",
  storageBucket: "tamil-chat-2d54e.appspot.com",
  messagingSenderId: "804705969240",
  appId: "1:804705969240:web:658df281dd8360843c162d"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

const messagesEl=document.getElementById('messages');
const messageInput=document.getElementById('messageInput');
const sendBtn=document.getElementById('sendBtn');
const toastEl=document.getElementById('toast');
const loginWrap=document.getElementById('loginWrap');
const nameInput=document.getElementById('nameInput');
const joinBtn=document.getElementById('joinBtn');
const onlineCount=document.getElementById('onlineCount');
const privatePopup=document.getElementById('privatePopup');
const privateMessages=document.getElementById('privateMessages');
const privateInput=document.getElementById('privateInput');
const privateSend=document.getElementById('privateSend');
const backToGroup=document.getElementById('backToGroup');
const privateTitle=document.getElementById('privateTitle');

let username=localStorage.getItem('guestName')||'';
let chatWith=null; // private target

function showToast(msg){
  toastEl.textContent=msg;
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'),2000);
}
function formatTime(ms){
  const d=new Date(ms); let h=d.getHours(),m=d.getMinutes().toString().padStart(2,'0');
  const ampm=h>=12?'PM':'AM'; h=h%12||12; return `${h}:${m} ${ampm}`;
}
function scrollDown(el){ setTimeout(()=>el.scrollTop=el.scrollHeight,80); }

function renderMsg(el,msg,isSelf=false){
  const row=document.createElement('div');
  row.className='msg-row'+(isSelf?' self':'');
  const bubble=document.createElement('div');
  bubble.className='bubble'; bubble.textContent=msg.text;
  const t=document.createElement('div');
  t.className='time'; t.textContent=formatTime(msg.time);
  row.append(bubble,t);
  el.appendChild(row);
  scrollDown(el);
}

function startChat(){
  if(!username){loginWrap.style.display='flex';return;}
  loginWrap.style.display='none';
  setOnline();
  loadGroup();
}
joinBtn.onclick=()=>{
  const v=nameInput.value.trim();
  if(!v)return showToast("Enter name");
  username=v;localStorage.setItem('guestName',v);
  startChat();
};

function setOnline(){
  db.ref(`status/${username}`).set(true);
  db.ref(`status/${username}`).onDisconnect().remove();
}

function loadGroup(){
  db.ref('messages').limitToLast(50).on('child_added',snap=>{
    const m=snap.val();
    const row=document.createElement('div');
    row.className='msg-row'+(m.name===username?' self':'');
    const avatar=document.createElement('div');
    avatar.className='avatar';avatar.textContent=m.name.charAt(0).toUpperCase();
    avatar.onclick=()=>{if(m.name!==username) openPrivate(m.name)};
    const bubble=document.createElement('div');
    bubble.className='bubble';bubble.textContent=m.text;
    const meta=document.createElement('div');
    meta.className='meta';meta.textContent=m.name;
    const t=document.createElement('div');
    t.className='time';t.textContent=formatTime(m.time);
    const content=document.createElement('div');
    content.style.display='flex';content.style.flexDirection='column';
    content.append(meta,bubble,t);
    row.append(avatar,content);
    messagesEl.appendChild(row);
    scrollDown(messagesEl);
  });
}

function sendMessage(){
  const text=messageInput.value.trim();if(!text)return;
  db.ref('messages').push({name:username,text,time:Date.now()});
  messageInput.value='';
}
sendBtn.onclick=sendMessage;
messageInput.onkeypress=e=>{if(e.key==='Enter')sendMessage();};

function openPrivate(user){
  chatWith=user;
  privateTitle.textContent=`Private Chat with ${user}`;
  privatePopup.style.display='flex';
  privateMessages.innerHTML='';
  loadPrivate();
}
function closePrivate(){
  privatePopup.style.display='none';
  chatWith=null;
}
backToGroup.onclick=closePrivate;

function privatePath(u1,u2){
  return `privates/${[u1,u2].sort().join('_')}`;
}
function loadPrivate(){
  const path=privatePath(username,chatWith);
  db.ref(path).limitToLast(10).on('child_added',snap=>{
    const m=snap.val();
    renderMsg(privateMessages,m,m.name===username);
  });
}
function sendPrivate(){
  if(!chatWith)return;
  const text=privateInput.value.trim();if(!text)return;
  const path=privatePath(username,chatWith);
  db.ref(path).push({name:username,text,time:Date.now()});
  privateInput.value='';
  cleanupPrivate(path,10);
}
privateSend.onclick=sendPrivate;
privateInput.onkeypress=e=>{if(e.key==='Enter')sendPrivate();};

function cleanupPrivate(path,limit){
  db.ref(path).once('value').then(s=>{
    const v=s.val()||{};const keys=Object.keys(v);
    if(keys.length>limit){
      const arr=keys.map(k=>({k,t:v[k].time||0})).sort((a,b)=>a.t-b.t);
      const del=arr.slice(0,arr.length-limit);
      const updates={};del.forEach(i=>updates[i.k]=null);
      db.ref(path).update(updates);
    }
  });
}

startChat();
</script>
</body>
</html>
