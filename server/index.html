<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WhatsApp-style Chat Pro</title>
<style>
:root{--bg:#111b21;--panel:#202c33;--accent:#25d366;--muted:#97a4ab}
body{margin:0;background:var(--bg);color:#e9edef;font-family:Arial;display:flex;flex-direction:column;height:100vh}
#app{max-width:900px;margin:auto;width:100%;display:flex;flex-direction:column;height:100vh}
#topBar{background:#0b141a;padding:8px 12px;display:flex;align-items:center;gap:12px}
#title{font-weight:600}
#messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;background:#071215}
.msg-row{display:flex;align-items:flex-end;max-width:80%;position:relative}
.msg-row.self{align-self:flex-end;flex-direction:row-reverse}
.avatar{width:36px;height:36px;border-radius:50%;background:#000;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;margin:0 8px;cursor:pointer;overflow:hidden;position:relative;border:2px solid transparent}
.avatar img{width:100%;height:100%;object-fit:cover}
.avatar.online{border-color:#25d366;box-shadow:0 0 0 0 rgba(37,211,102,.7);animation:pulse 1.5s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(37,211,102,.7)}70%{box-shadow:0 0 0 6px rgba(37,211,102,0)}100%{box-shadow:0 0 0 0 rgba(37,211,102,0)}}
.bubble{background:var(--panel);padding:8px 12px;border-radius:12px;font-size:14px}
.msg-row.self .bubble{background:#005c4b}
.time{font-size:11px;color:var(--muted);margin-top:4px;text-align:right}
#inputBar{display:flex;padding:10px;background:var(--panel);align-items:center;gap:8px}
#messageInput{flex:1;padding:10px;border-radius:22px;border:0;background:#2a3942;color:#fff;font-size:14px}
#sendBtn{width:44px;height:44px;border-radius:50%;border:0;background:var(--accent);color:#fff;font-size:18px;cursor:pointer}
#toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#2a3942;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:opacity .25s,bottom .25s;z-index:999}
#toast.show{opacity:1;bottom:40px}
#loginWrap,#settingsWrap,#privatePopup{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:1000}
.card{background:#0b141a;padding:20px;border-radius:12px;display:flex;flex-direction:column;gap:10px;min-width:260px}
.card input{padding:10px;border-radius:10px;border:0;background:#162027;color:#fff}
.card button{padding:10px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer}
</style>
</head>
<body>
<div id="app">
  <div id="topBar">
    <div id="title">Group Chat</div>
    <div style="flex:1"></div>
    <button id="settingsBtn" style="background:none;border:0;color:#25d366;cursor:pointer;">⚙️</button>
  </div>
  <div id="messages"></div>
  <div id="inputBar">
    <input id="messageInput" placeholder="Type a message"/>
    <button id="sendBtn">✈️</button>
  </div>
</div>

<div id="loginWrap">
  <div class="card">
    <div style="font-weight:700;">Login / Register</div>
    <input id="nameInput" placeholder="Username"/>
    <input id="passInput" placeholder="Password" type="password"/>
    <label style="font-size:13px;">Profile Photo (optional)</label>
    <input id="photoInput" type="file" accept="image/*"/>
    <button id="loginBtn">Continue</button>
  </div>
</div>

<div id="settingsWrap">
  <div class="card">
    <h3>Profile Settings</h3>
    <div>
      <label><input type="checkbox" id="privateChatToggle"/> Private Chat On</label>
    </div>
    <button id="closeSettings">Close</button>
  </div>
</div>

<div id="privatePopup">
  <div class="card" style="min-width:300px;">
    <div id="privateTitle" style="font-weight:600;margin-bottom:6px;"></div>
    <div id="privateMsgs" style="background:#071215;height:250px;overflow:auto;padding:8px;border-radius:8px;"></div>
    <div style="display:flex;gap:8px;">
      <input id="privateInput" placeholder="Type a message" style="flex:1;padding:8px;border-radius:8px;border:0;background:#162027;color:#fff;"/>
      <button id="privateSend">Send</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig={apiKey:"AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",authDomain:"tamil-chat-2d54e.firebaseapp.com",databaseURL:"https://tamil-chat-2d54e-default-rtdb.firebaseio.com",projectId:"tamil-chat-2d54e",storageBucket:"tamil-chat-2d54e.appspot.com",messagingSenderId:"804705969240",appId:"1:804705969240:web:658df281dd8360843c162d"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

const loginWrap=document.getElementById('loginWrap');
const settingsWrap=document.getElementById('settingsWrap');
const nameInput=document.getElementById('nameInput');
const passInput=document.getElementById('passInput');
const photoInput=document.getElementById('photoInput');
const loginBtn=document.getElementById('loginBtn');
const privateChatToggle=document.getElementById('privateChatToggle');
const closeSettings=document.getElementById('closeSettings');
const settingsBtn=document.getElementById('settingsBtn');
const messagesEl=document.getElementById('messages');
const input=document.getElementById('messageInput');
const sendBtn=document.getElementById('sendBtn');
const toastEl=document.getElementById('toast');

let user={},privateWith='',photoData='';

function toast(msg){toastEl.textContent=msg;toastEl.classList.add('show');setTimeout(()=>toastEl.classList.remove('show'),2000);}
function scrollDown(el){setTimeout(()=>el.scrollTop=el.scrollHeight,100);}

photoInput.onchange=e=>{
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();r.onload=()=>photoData=r.result;r.readAsDataURL(file);
};

loginBtn.onclick=async()=>{
  const name=nameInput.value.trim(),pass=passInput.value.trim();
  if(!name||!pass)return toast("Enter username & password");
  const snap=await db.ref("users/"+name).once("value");
  if(snap.exists()){
    const data=snap.val();
    if(data.password!==pass)return toast("Wrong password");
    user={name,...data};
  }else{
    await db.ref("users/"+name).set({password:pass,photo:photoData||"",privateChat:true});
    user={name,password:pass,photo:photoData||"",privateChat:true};
  }
  loginWrap.style.display="none";
  setOnline();listenGroup();
};

settingsBtn.onclick=()=>{settingsWrap.style.display='flex';privateChatToggle.checked=user.privateChat;};
closeSettings.onclick=()=>settingsWrap.style.display='none';
privateChatToggle.onchange=()=>{user.privateChat=privateChatToggle.checked;db.ref('users/'+user.name+'/privateChat').set(user.privateChat);};

function setOnline(){
  db.ref('users/'+user.name+'/online').set(true);
  db.ref('users/'+user.name+'/online').onDisconnect().remove();
}

function renderMessage(msg){
  const self=msg.name===user.name;
  const row=document.createElement('div');
  row.className='msg-row'+(self?' self':'');
  const avatar=document.createElement('div');
  avatar.className='avatar';
  avatar.innerHTML=msg.photo?`<img src="${msg.photo}"/>`:msg.name[0].toUpperCase();
  avatar.onclick=()=>{if(!self)openPrivateChat(msg.name)};
  const bubble=document.createElement('div');
  bubble.className='bubble';bubble.textContent=msg.text;
  row.append(avatar,bubble);
  messagesEl.append(row);
  scrollDown(messagesEl);
}

function listenGroup(){
  db.ref('messages/group').on('child_added',snap=>{
    const m=snap.val();
    renderMessage(m);
  });
}

sendBtn.onclick=()=>{
  const text=input.value.trim();if(!text)return;
  db.ref('messages/group').push({name:user.name,text,photo:user.photo,time:Date.now()});
  input.value='';
};

// PRIVATE CHAT
const privatePopup=document.getElementById('privatePopup');
const privateTitle=document.getElementById('privateTitle');
const privateMsgs=document.getElementById('privateMsgs');
const privateInput=document.getElementById('privateInput');
const privateSend=document.getElementById('privateSend');

function openPrivateChat(target){
  db.ref('users/'+target).once('value').then(s=>{
    const u=s.val();
    if(!u.privateChat)return toast("User has disabled private chat");
    privateWith=target;
    privateTitle.textContent="Chat with "+target;
    privateMsgs.innerHTML="";
    privatePopup.style.display="flex";
    const path=chatPath(user.name,target);
    db.ref(path).off();
    db.ref(path).on('child_added',snap=>{
      const m=snap.val();
      const div=document.createElement('div');
      div.style.margin="4px 0";div.textContent=`${m.from}: ${m.text}`;
      privateMsgs.append(div);scrollDown(privateMsgs);
    });
  });
}

function chatPath(a,b){
  return 'messages/private/'+[a,b].sort().join('_');
}

privateSend.onclick=()=>{
  const text=privateInput.value.trim();if(!text)return;
  const path=chatPath(user.name,privateWith);
  db.ref(path).push({from:user.name,to:privateWith,text,time:Date.now()});
  privateInput.value='';
};
privatePopup.onclick=e=>{if(e.target===privatePopup)privatePopup.style.display='none';};

</script>
</body>
</html>
