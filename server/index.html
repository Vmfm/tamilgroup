<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WhatsApp-style Group + Private Chat (with notifications toggle)</title>
<style>
:root{--bg:#111b21;--panel:#202c33;--accent:#25d366;--muted:#97a4ab}
body{margin:0;background:var(--bg);color:#e9edef;font-family:Arial,system-ui;min-height:100vh;display:flex;flex-direction:column}
#app{max-width:900px;margin:0 auto;width:100%;height:100vh;display:flex;flex-direction:column}
#topBar{padding:8px 12px;background:#0b141a;display:flex;align-items:center;gap:12px}
#title{font-weight:600}
#notifBar{display:none;background:#21302b;color:#e6ffef;padding:8px 12px;border-radius:6px;margin-left:12px;cursor:pointer}
#messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;background:#071215}
.msg-row{display:flex;align-items:flex-end;max-width:80%;position:relative}
.msg-row.self{align-self:flex-end;flex-direction:row-reverse}
.avatar{width:36px;height:36px;border-radius:50%;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;margin:0 8px;position:relative;cursor:pointer;border:2px solid transparent;transition:border .18s ease-in-out;overflow:hidden}
.avatar.online{border-color:var(--accent);box-shadow:0 0 0 0 rgba(37,211,102,.6);animation:pulse 1.5s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(37,211,102,.6)}70%{box-shadow:0 0 0 6px rgba(37,211,102,0)}100%{box-shadow:0 0 0 0 rgba(37,211,102,0)}}
.popup-menu{display:none;position:absolute;top:-44px;left:0;background:var(--panel);border-radius:8px;padding:6px;flex-direction:column;z-index:30;min-width:110px}
.avatar:hover .popup-menu{display:flex}
.popup-menu button{background:none;border:0;color:#fff;padding:6px 8px;text-align:left;cursor:pointer;border-radius:6px}
.bubble{background:var(--panel);padding:8px 12px;border-radius:12px;font-size:14px;line-height:1.3;word-break:break-word}
.msg-row.self .bubble{background:#005c4b}
.meta{font-size:12px;color:#53bdeb;margin-bottom:4px;display:flex;align-items:center;gap:8px}
.time{font-size:11px;color:var(--muted);margin-top:6px;text-align:right}
#inputBar{display:flex;padding:10px;background:var(--panel);align-items:center;gap:8px}
#messageInput{flex:1;padding:10px;border-radius:22px;border:0;background:#2a3942;color:#fff;outline:none;font-size:14px}
#sendBtn{width:44px;height:44px;border-radius:50%;border:0;background:var(--accent);color:#fff;font-size:18px;cursor:pointer}
#statusLine{padding:6px 12px;font-size:13px;color:var(--muted);background:#071215}
#toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#2a3942;color:#fff;padding:10px 14px;border-radius:10px;z-index:999;opacity:0;transition:opacity .25s,bottom .25s}
#toast.show{opacity:1;bottom:40px}
#loginWrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:999}
#loginCard{background:#0b141a;padding:18px;border-radius:12px;display:flex;flex-direction:column;gap:10px;min-width:260px}
#loginCard input{padding:10px;border-radius:10px;border:0;background:#162027;color:#fff}
#loginCard button{padding:10px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer}

/* private popup */
#privatePopup{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:1000}
.card{background:#0b141a;padding:12px;border-radius:12px;max-width:680px;width:96%;display:flex;flex-direction:column;max-height:92%}
#privateHeader{display:flex;align-items:center;gap:8px;margin-bottom:8px;position:relative}
#privateMessages{flex:1;overflow:auto;padding:8px;background:#071215;border-radius:8px;display:flex;flex-direction:column;gap:8px}
.private-bubble{background:#162027;padding:8px 10px;border-radius:10px;max-width:80%}
.private-row.self{align-self:flex-end}
#privateInputBar{display:flex;gap:8px;margin-top:8px}
#privateInput{flex:1;padding:10px;border-radius:22px;border:0;background:#2a3942;color:#fff}
#privateSend{width:44px;height:44px;border-radius:50%;border:0;background:var(--accent);color:#fff;font-size:18px;cursor:pointer}
#typingPrivate{font-size:13px;color:var(--muted);margin-left:8px}

/* toggle switch */
#settingsBtn{position:absolute;top:8px;right:8px;background:none;border:0;color:var(--accent);cursor:pointer;font-size:18px;}
#settingsPopup{position:absolute;top:36px;right:16px;background:#162027;color:#fff;padding:12px;border-radius:8px;display:none;z-index:1001;font-size:13px;}
#settingsPopup label{display:flex;align-items:center;gap:8px;cursor:pointer;}
#settingsPopup input[type="checkbox"]{opacity:0;width:0;height:0;}
#notifSlider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#555;border-radius:20px;transition:.4s;}
#notifCircle{position:absolute;top:2px;left:2px;width:16px;height:16px;background:white;border-radius:50%;transition:.4s;}
</style>
</head>
<body>
<div id="app">
  <div id="topBar">
    <div id="title">Group Chat</div>
    <div style="flex:1"></div>
    <div id="notifBar">New message</div>
    <div id="onlineCount" style="color:var(--muted);font-size:13px;margin-left:12px"></div>
  </div>

  <div id="statusLine"></div>
  <div id="messages" aria-live="polite"></div>

  <div id="inputBar">
    <input id="messageInput" placeholder="Type a message" autocomplete="off"/>
    <button id="sendBtn">✈️</button>
  </div>
</div>

<div id="toast"></div>

<div id="loginWrap" style="display:none">
  <div id="loginCard">
    <div style="font-weight:700;color:#fff">Enter your name</div>
    <input id="nameInput" placeholder="Your name" />
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="joinBtn">Join</button>
    </div>
    <div style="font-size:12px;color:var(--muted)">Name is saved to this device.</div>
  </div>
</div>

<!-- Private chat modal -->
<div id="privatePopup">
  <div class="card">
    <div id="privateHeader">
      <button id="closePrivate" style="background:none;border:0;color:var(--accent);font-size:18px;cursor:pointer">⬅</button>
      <div style="font-weight:700" id="privateTitle">Private Chat</div>
      <div style="flex:1"></div>
      <div id="privateOnline" style="color:var(--muted);font-size:13px"></div>
      <button id="settingsBtn">⚙️</button>
    </div>

    <div id="settingsPopup">
      <label>
        Notifications
        <div style="position:relative;width:40px;height:20px">
          <input type="checkbox" id="notifToggle"/>
          <span id="notifSlider"></span>
          <span id="notifCircle"></span>
        </div>
      </label>
    </div>

    <div id="privateMessages"></div>
    <div style="display:flex;align-items:center;gap:12px;margin-top:8px">
      <div id="typingPrivate" class="small"></div>
    </div>

    <div id="privateInputBar">
      <input id="privateInput" placeholder="Type a private message" autocomplete="off"/>
      <button id="privateSend">✈️</button>
    </div>
  </div>
</div>

<!-- ding sound -->
<audio id="dingAudio" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA="></audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
  authDomain: "tamil-chat-2d54e.firebaseapp.com",
  databaseURL: "https://tamil-chat-2d54e-default-rtdb.firebaseio.com",
  projectId: "tamil-chat-2d54e",
  storageBucket: "tamil-chat-2d54e.appspot.com",
  messagingSenderId: "804705969240",
  appId: "1:804705969240:web:658df281dd8360843c162d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// DOM refs
const messagesEl = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const statusLine = document.getElementById('statusLine');
const onlineCountEl = document.getElementById('onlineCount');
const toastEl = document.getElementById('toast');

const loginWrap = document.getElementById('loginWrap');
const nameInput = document.getElementById('nameInput');
const joinBtn = document.getElementById('joinBtn');

const notifBar = document.getElementById('notifBar');
const dingAudio = document.getElementById('dingAudio');

const privatePopup = document.getElementById('privatePopup');
const privateTitle = document.getElementById('privateTitle');
const privateMessages = document.getElementById('privateMessages');
const privateInput = document.getElementById('privateInput');
const privateSend = document.getElementById('privateSend');
const closePrivate = document.getElementById('closePrivate');
const privateOnline = document.getElementById('privateOnline');
const typingPrivate = document.getElementById('typingPrivate');

const settingsBtn = document.getElementById('settingsBtn');
const settingsPopup = document.getElementById('settingsPopup');
const notifToggle = document.getElementById('notifToggle');
const notifSlider = document.getElementById('notifSlider');
const notifCircle = document.getElementById('notifCircle');

let username = localStorage.getItem('guestName') || '';
let currentPrivateRef = null;
let privateChatWith = null;
let typingTimer = null;
let privateTypingTimer = null;

const privateListeners = new Map();

// helpers
function showToast(msg){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=> toastEl.classList.remove('show'), 1600); }
function formatTime(ms){ const d=new Date(ms); let h=d.getHours(), m=d.getMinutes().toString().padStart(2,'0'); const ampm = h>=12?'PM':'AM'; h=h%12||12; return `${h}:${m} ${ampm}`; }
function scrollToBottomSoon(el){ setTimeout(()=> { el.scrollTop = el.scrollHeight; }, 80); }
function chatId(a,b){ return [a,b].sort().join('_'); }

// toggle settings popup
settingsBtn.onclick = () => { settingsPopup.style.display = settingsPopup.style.display==='flex'?'none':'flex'; }

// toggle visual
function updateToggleVisual(state){
  if(state){
    notifSlider.style.background = '#25d366';
    notifCircle.style.transform = 'translateX(20px)';
  } else {
    notifSlider.style.background = '#555';
    notifCircle.style.transform = 'translateX(0)';
  }
}

// load saved per-chat setting
function loadPrivateSettings(chatUser){
  const key = `notif_${chatId(username, chatUser)}`;
  const saved = localStorage.getItem(key);
  const state = saved === null ? true : saved === 'true';
  notifToggle.checked = state;
  updateToggleVisual(state);
}

// save toggle change
notifToggle.addEventListener('change', ()=>{
  if(privateChatWith){
    const key = `notif_${chatId(username, privateChatWith)}`;
    const state = notifToggle.checked;
    localStorage.setItem(key, state);
    updateToggleVisual(state);
  }
});
notifSlider.onclick = () => { notifToggle.checked = !notifToggle.checked; notifToggle.dispatchEvent(new Event('change')); };
notifCircle.onclick = () => { notifToggle.checked = !notifToggle.checked; notifToggle.dispatchEvent(new Event('change')); };

// rest of your private message, group chat, presence, typing, send, render logic goes here...
// You can reuse your existing code and add calls to loadPrivateSettings(privateChatWith) when opening a private chat.
// Also, when showing notification, check localStorage key `notif_${chatId(username, otherUser)}` to decide whether to play ding or show toast.
</script>
</body>
</html>
