<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WhatsApp Style Group Chat</title>
<style>
  body {margin:0;font-family:Arial,sans-serif;background-color:#111b21;color:#e9edef;display:flex;flex-direction:column;height:100vh;}
  #chatPage {flex:1;display:flex;flex-direction:column;}
  #messages {flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px;}
  .message {display:flex;align-items:flex-end;max-width:80%;margin-bottom:5px;position:relative;}
  .message.self {align-self:flex-end;flex-direction:row-reverse;}
  .avatar {width:32px;height:32px;border-radius:50%;background:#000;color:#fff;font-weight:bold;display:flex;align-items:center;justify-content:center;margin:0 6px;font-size:16px;user-select:none;position:relative;cursor:pointer;}
  .bubble {background-color:#202c33;padding:8px 12px;border-radius:10px;font-size:14px;line-height:1.3;word-wrap:break-word;position:relative;}
  .message.self .bubble {background-color:#005c4b;}
  .username {font-size:12px;color:#53bdeb;}
  .timestamp {font-size:10px;color:#aaa;margin-top:2px;text-align:right;}
  #inputArea {display:flex;padding:8px;background-color:#202c33;align-items:center;position:sticky;bottom:0;}
  #messageInput {flex:1;padding:8px;border:none;border-radius:20px;outline:none;font-size:14px;background-color:#2a3942;color:#fff;}
  #sendBtn {width:40px;height:40px;border-radius:50%;border:none;background:#25d366;color:white;font-size:20px;margin-left:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
  #loginPage {display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background-color:#111b21;}
  #loginPage input,#loginPage button {padding:10px;margin:5px;border-radius:20px;border:none;}
  #loginPage button {background-color:#25d366;color:white;font-weight:bold;cursor:pointer;}
  #typingIndicator {font-size:12px;color:#aaa;padding-left:15px;margin-bottom:3px;}
  .popup-menu {display:none;position:absolute;top:-35px;right:0;background:#2a3942;border-radius:5px;padding:3px 5px;font-size:12px;z-index:10;flex-direction:column;}
  .avatar:hover .popup-menu {display:flex;}
  .popup-menu button {background:none;border:none;color:#fff;cursor:pointer;margin:2px 0;}
  .status-online {color:#00ff00;font-size:10px;margin-left:5px;}
</style>
</head>
<body>
<div id="loginPage">
  <h2>Enter Your Name</h2>
  <input type="text" id="usernameInput" placeholder="Your name">
  <button id="loginBtn">Join Chat</button>
</div>

<div id="chatPage" style="display:none;">
  <div id="messages"></div>
  <div id="typingIndicator"></div>
  <div id="inputArea">
    <input type="text" id="messageInput" placeholder="Type a message">
    <button id="sendBtn">‚úàÔ∏è</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
  authDomain: "tamil-chat-2d54e.firebaseapp.com",
  databaseURL: "https://tamil-chat-2d54e-default-rtdb.firebaseio.com",
  projectId: "tamil-chat-2d54e",
  storageBucket: "tamil-chat-2d54e.appspot.com",
  messagingSenderId: "804705969240",
  appId: "1:804705969240:web:658df281dd8360843c162d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const loginPage = document.getElementById('loginPage');
const chatPage = document.getElementById('chatPage');
const messagesDiv = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const typingIndicator = document.getElementById('typingIndicator');

let username = localStorage.getItem('guestName') || "";
let userReports = {};
let blockedUsers = {};
let typingTimeout;

// Auto-login
if(username) startChat();

document.getElementById('loginBtn').onclick = () => {
  username = document.getElementById('usernameInput').value.trim();
  if(!username) return;
  localStorage.setItem('guestName', username);
  startChat();
};

function startChat(){
  loginPage.style.display='none';
  chatPage.style.display='flex';
  db.ref('status/'+username).set(true);
  db.ref('status/'+username).onDisconnect().remove();
  listenMessages();
  listenTyping();
  listenOnline();
}

function listenMessages(){
  db.ref('messages').limitToLast(50).on('child_added', snap => {
    const data = snap.val();
    if(data.banned || blockedUsers[data.name]) return;
    renderMessage(data, data.name===username, snap.key);
  });
}

function renderMessage(data, self, key){
  const div = document.createElement('div');
  div.className = 'message' + (self?' self':'');

  const avatar = document.createElement('div');
  avatar.className='avatar';
  avatar.textContent = data.name.charAt(0).toUpperCase();

  // Popup menu inside avatar
  const popup = document.createElement('div');
  popup.className='popup-menu';

  if(self){
    const delBtn=document.createElement('button');
    delBtn.textContent='üóëÔ∏è';
    delBtn.onclick=()=>{db.ref('messages/'+key).remove(); div.remove();}
    popup.appendChild(delBtn);
  } else {
    const reportBtn=document.createElement('button');
    reportBtn.textContent='üö©';
    reportBtn.onclick=()=>reportUser(data.name);
    const blockBtn=document.createElement('button');
    blockBtn.textContent='üö´';
    blockBtn.onclick=()=>{blockedUsers[data.name]=true; alert('Blocked '+data.name);}
    popup.appendChild(reportBtn);
    popup.appendChild(blockBtn);
  }

  avatar.appendChild(popup);

  const content = document.createElement('div');
  const nameEl = document.createElement('div');
  nameEl.className='username';
  nameEl.textContent = data.name;
  if(data.online) {
    const onlineEl = document.createElement('span'); 
    onlineEl.className='status-online'; 
    onlineEl.textContent='‚óè';
    nameEl.appendChild(onlineEl);
  }

  const bubble = document.createElement('div');
  bubble.className='bubble';
  bubble.textContent=data.text;

  const timeEl = document.createElement('div');
  timeEl.className='timestamp';
  timeEl.textContent=formatTime(data.time);

  content.appendChild(nameEl);
  content.appendChild(bubble);
  content.appendChild(timeEl);

  div.appendChild(avatar);
  div.appendChild(content);
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

sendBtn.onclick = ()=>{
  const text=messageInput.value.trim();
  if(!text) return;
  const msg={name:username,text,time:Date.now(),online:true};
  db.ref('messages').push(msg);
  messageInput.value='';
  cleanupOldMessages();
};

messageInput.addEventListener('input',()=>{
  db.ref('typing/'+username).set(true);
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>db.ref('typing/'+username).remove(),2000);
});

function cleanupOldMessages(){
  db.ref('messages').once('value',snap=>{
    const data = snap.val();
    if(!data) return;
    const keys=Object.keys(data);
    if(keys.length>50){
      const toDelete=keys.slice(0,keys.length-50);
      toDelete.forEach(k=>db.ref('messages/'+k).remove());
    }
  });
}

function formatTime(ms){
  const date=new Date(ms);
  let h=date.getHours();
  const m=date.getMinutes().toString().padStart(2,'0');
  const ampm=h>=12?'PM':'AM';
  h=h%12||12;
  return h+':'+m+' '+ampm;
}

// REPORT system
function reportUser(user){
  if(user===username) return alert("Cannot report yourself!");
  if(userReports[user]) return alert("You already reported this user!");
  userReports[user]=true;

  db.ref('reports/'+user+'/'+username).set(true).then(()=>{
    db.ref('reports/'+user).once('value',snap=>{
      if(snap.numChildren()>=3){
        db.ref('messages').orderByChild('name').equalTo(user).once('value',ms=>{
          ms.forEach(m=>m.ref.update({banned:true}));
        });
        const notify={name:'System',text:user+' has been removed from the group',time:Date.now()};
        db.ref('messages').push(notify);
      }
    });
    alert("User reported successfully!");
  });
}

// TYPING indicator
function listenTyping(){
  db.ref('typing').on('value',snap=>{
    const val = snap.val() || {};
    delete val[username];
    const usersTyping = Object.keys(val);
    typingIndicator.textContent = usersTyping.length>0 ? usersTyping.join(', ') + ' is typing...' : '';
  });
}

// ONLINE indicator
function listenOnline(){
  db.ref('status').on('value',snap=>{
    const val = snap.val() || {};
    document.querySelectorAll('.message').forEach(msgDiv=>{
      const nameEl = msgDiv.querySelector('.username');
      const user = nameEl.textContent.replace('‚óè','').trim();
      if(val[user]) {
        if(!nameEl.querySelector('.status-online')){
          const dot = document.createElement('span'); dot.className='status-online'; dot.textContent='‚óè';
          nameEl.appendChild(dot);
        }
      } else {
        const dot = nameEl.querySelector('.status-online');
        if(dot) dot.remove();
      }
    });
  });
}
</script>
</body>
</html>
