<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tamil Chat Profiles</title>
<script type="module">
// Firebase App (the core Firebase SDK)
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase, ref, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// Your Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
  authDomain: "tamil-chat-2d54e.firebaseapp.com",
  databaseURL: "https://tamil-chat-2d54e-default-rtdb.firebaseio.com",
  projectId: "tamil-chat-2d54e",
  storageBucket: "tamil-chat-2d54e.appspot.com",
  messagingSenderId: "804705969240",
  appId: "1:804705969240:web:658df281dd8360843c162d"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Elements
const loginForm = document.getElementById("loginForm");
const profileSection = document.getElementById("profiles");
const popup = document.getElementById("popup");
const popupName = document.getElementById("popupName");
let selectedUserId = null;

// Register/Login Form Submit
loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const username = loginForm.username.value;
  const age = loginForm.age.value;
  const gender = loginForm.gender.value;
  const email = loginForm.email.value;
  const password = loginForm.password.value;
  const image = loginForm.image.files[0];

  // Convert image to base64
  const reader = new FileReader();
  reader.readAsDataURL(image);
  reader.onload = async () => {
    const imageUrl = reader.result;

    // Create account
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const uid = userCredential.user.uid;

      // Save user info to database
      await set(ref(db, "users/" + uid), {
        username,
        age,
        gender,
        imageUrl,
        online: true
      });

      loginForm.reset();
      alert("Account created and logged in!");
    } catch (error) {
      alert(error.message);
    }
  };
});

// Listen to auth state changes
onAuthStateChanged(auth, (user) => {
  if (user) {
    loginForm.style.display = "none";
    profileSection.style.display = "flex";
    loadProfiles();
  } else {
    loginForm.style.display = "block";
    profileSection.style.display = "none";
  }
});

// Load all profiles
function loadProfiles() {
  const usersRef = ref(db, "users/");
  onValue(usersRef, (snapshot) => {
    profileSection.innerHTML = "";
    const users = snapshot.val();
    let count = 0;
    for (const uid in users) {
      if (count >= 3) break; // show only 3 images one by one
      const user = users[uid];
      const div = document.createElement("div");
      div.classList.add("user-card");
      div.innerHTML = `
        <img src="${user.imageUrl}" alt="${user.username}" onclick="openPopup('${uid}')">
        <span class="online-dot ${user.online ? 'online' : ''}"></span>
        <p>${user.username}, ${user.age}, ${user.gender}</p>
      `;
      profileSection.appendChild(div);
      count++;
    }
  });
}

// Popup actions
window.openPopup = function(uid) {
  selectedUserId = uid;
  const userRef = ref(db, "users/" + uid);
  onValue(userRef, (snapshot) => {
    const user = snapshot.val();
    popupName.textContent = user.username;
    popup.style.display = "block";
  }, { once: true });
};

document.getElementById("closePopup").addEventListener("click", () => {
  popup.style.display = "none";
});

document.getElementById("chatBtn").addEventListener("click", () => {
  alert("Open chat with user " + selectedUserId);
});

document.getElementById("audioBtn").addEventListener("click", () => {
  alert("Start audio call with user " + selectedUserId);
});

document.getElementById("videoBtn").addEventListener("click", () => {
  alert("Start video call with user " + selectedUserId);
});

document.getElementById("blockBtn").addEventListener("click", async () => {
  if (!selectedUserId) return;
  await update(ref(db, "users/" + selectedUserId), { blocked: true });
  alert("User blocked");
});

document.getElementById("unblockBtn").addEventListener("click", async () => {
  if (!selectedUserId) return;
  await update(ref(db, "users/" + selectedUserId), { blocked: false });
  alert("User unblocked");
});
</script>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f0f0f0;
  margin: 0;
  padding: 0;
  text-align: center;
}
form { margin: 50px auto; background: white; padding: 20px; border-radius: 10px; width: 300px; box-shadow: 0 0 10px rgba(0,0,0,0.2);}
input, select { width: 100%; margin: 10px 0; padding: 8px; }
#profiles { display: none; justify-content: center; gap: 20px; margin: 50px; flex-wrap: wrap;}
.user-card { position: relative; display: inline-block; }
.user-card img { width: 150px; height: 150px; border-radius: 10px; cursor: pointer; object-fit: cover; }
.user-card .online-dot { position: absolute; top: 10px; right: 10px; width: 15px; height: 15px; border-radius: 50%; background: gray; border: 2px solid white; }
.user-card .online-dot.online { background: green; }
.user-card p { margin: 5px 0; }
#popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
  background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.3);}
#popup button { margin: 5px; padding: 10px 15px; }
#closePopup { position: absolute; top: 5px; right: 10px; cursor: pointer; font-weight: bold;}
</style>
</head>
<body>

<h1>Tamil Chat Login</h1>
<form id="loginForm">
  <input type="text" name="username" placeholder="Username" required>
  <input type="number" name="age" placeholder="Age" required>
  <select name="gender" required>
    <option value="">Select Gender</option>
    <option value="Male">Male</option>
    <option value="Female">Female</option>
    <option value="Other">Other</option>
  </select>
  <input type="email" name="email" placeholder="Email" required>
  <input type="password" name="password" placeholder="Password" required>
  <input type="file" name="image" accept="image/*" required>
  <button type="submit">Login / Register</button>
</form>

<div id="profiles"></div>

<div id="popup">
  <span id="closePopup">X</span>
  <h3 id="popupName"></h3>
  <button id="chatBtn">Chat</button>
  <button id="audioBtn">Audio Call</button>
  <button id="videoBtn">Video Call</button>
  <button id="blockBtn">Block</button>
  <button id="unblockBtn">Unblock</button>
</div>

</body>
</html>
