<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tamil VM Chat ‚Äì Full</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --bg:#0b141a;
  --card:#111b21;
  --bar:#202c33;
  --accent:#00a884;
  --muted:#8696a0;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;font-family:system-ui}
button{cursor:pointer}

/* TOP BAR */
#topBar{display:flex;align-items:center;padding:10px;background:var(--bar)}
#titleText{font-weight:700}
#notifWrap{display:flex;align-items:center;gap:12px;position:relative}
.bell{position:relative;font-size:20px;cursor:pointer}
.badge{position:absolute;top:-5px;right:-5px;background:red;border-radius:50%;padding:2px 5px;font-size:10px;display:none}

/* MESSAGES */
#messages,#privateMessages{flex:1;overflow:auto;padding:10px}
.msg{margin:4px 0}

/* INPUT BARS */
#inputBar,#privateInputBar{display:flex;padding:10px;background:var(--bar);gap:8px}
input{flex:1;padding:8px;border-radius:6px;border:0}

/* LOGIN */
#loginWrap{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:999}
#loginCard{background:var(--card);padding:20px;border-radius:10px;display:flex;flex-direction:column;gap:10px}

/* PRIVATE CHAT */
#privatePopup{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:9999}
#privatePopup .card{height:100%;display:flex;flex-direction:column;background:var(--card)}
#privateHeader{display:flex;align-items:center;padding:10px;background:var(--bar);gap:10px}

/* CALL */
#callOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:2000;align-items:center;justify-content:center}
.callCard{background:var(--card);padding:20px;border-radius:12px;text-align:center}
#inCallBar{display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#000;padding:10px;border-radius:10px;z-index:2000}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginWrap">
  <div id="loginCard">
    <div style="font-weight:700;color:#fff">Enter your name</div>
    <input id="nameInput" placeholder="Your name" />
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="joinBtn">Join</button>
    </div>
    <div style="font-size:12px;color:var(--muted)">Name is saved to this device.</div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none;flex-direction:column;height:100vh;">
  <div id="topBar">
    <div id="titleText">Group Chat</div>
    <div style="flex:1"></div>

    <div id="notifWrap">
      <!-- Bell badge -->
      <div class="bell" id="bellBtn" title="Private messages">üîî
        <div class="badge" id="bellBadge">0</div>
      </div>

      <!-- Settings -->
      <div id="settingsWrap" style="position:relative">
        <button id="settingsBtn">‚öôÔ∏è</button>
        <div id="settingsPanel" role="dialog" aria-label="Settings" style="display:none;position:absolute;top:40px;right:0;background:var(--card);padding:10px;border-radius:6px">
          <div class="settingRow">
            <div>Audio Call</div>
            <div class="toggleBtn" id="toggleCall"><div class="toggleKnob" id="toggleCallKnob"></div></div>
          </div>
          <div class="settingRow">
            <div>Private Chat</div>
            <div class="toggleBtn" id="togglePrivate"><div class="toggleKnob" id="togglePrivateKnob"></div></div>
          </div>
          <div class="settingRow">
            <div>Profile Image</div>
            <input type="file" id="profileImgInput" accept="image/*" style="color:#fff;font-size:12px">
          </div>
          <div class="settingRow">
            <div></div>
            <div style="font-size:12px;color:var(--muted)">Your image is saved to your profile.</div>
          </div>
        </div>
      </div>
    </div>

    <div id="onlineCount" style="color:var(--muted);font-size:13px;margin-left:12px"></div>
  </div>

  <div id="statusLine"></div>
  <div id="messages" aria-live="polite" style="flex:1;overflow:auto;"></div>

  <div id="inputBar">
    <input id="messageInput" placeholder="Type a message">
    <button id="sendBtn">‚û§</button>
  </div>
</div>

<!-- PRIVATE CHAT MODAL -->
<div id="privatePopup">
  <div class="card">
    <div id="privateHeader">
      <button id="closePrivate">‚¨Ö</button>
      <b id="privateTitle">Private Chat</b>
      <div style="flex:1"></div>
      <button id="callBtn">üìû</button>
      <button id="blockBtn">üö´</button>
    </div>
    <div id="privateMessages" style="flex:1;overflow:auto;padding:10px"></div>
    <div id="privateInputBar">
      <input id="privateInput" placeholder="Type a private message">
      <button id="privateSend">‚û§</button>
    </div>
  </div>
</div>

<!-- CALL OVERLAY -->
<div id="callOverlay">
  <div class="callCard">
    <div style="color:var(--muted)">Incoming Call</div>
    <h2 id="callFrom"></h2>
    <button id="acceptCallBtn">Accept</button>
    <button id="declineCallBtn">Decline</button>
  </div>
</div>

<!-- IN CALL BAR -->
<div id="inCallBar">
  Call with <span id="inCallWith"></span> |
  <span id="inCallElapsed">00:00</span>
  <button id="endCallBtn">End</button>
</div>

<audio id="remoteAudio" autoplay></audio>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyB1VbLbqBxCiG_bfGoQgQyapXwHUQ-Q7BU",
  authDomain: "tamil-chat-2d54e.firebaseapp.com",
  databaseURL: "https://tamil-chat-2d54e-default-rtdb.firebaseio.com",
  projectId: "tamil-chat-2d54e",
  storageBucket: "tamil-chat-2d54e.appspot.com",
  messagingSenderId: "804705969240",
  appId: "1:804705969240:web:658df281dd8360843c162d"
});
const db=firebase.database();

/* LOGIN */
let username;
joinBtn.onclick=()=>{
  username=nameInput.value.trim();
  if(!username) return;
  localStorage.setItem("name",username);
  loginWrap.style.display="none";
  app.style.display="flex";
  startApp();
};
if(localStorage.getItem("name")){
  username=localStorage.getItem("name");
  loginWrap.style.display="none";
  app.style.display="flex";
  startApp();
}

function startApp(){
  /* GROUP CHAT */
  sendBtn.onclick=()=>{
    if(!messageInput.value) return;
    db.ref("group").push({u:username,m:messageInput.value});
    messageInput.value="";
  };
  db.ref("group").limitToLast(50).on("child_added",s=>{
    messages.innerHTML+=`<div class="msg"><b>${s.val().u}:</b> ${s.val().m}</div>`;
    messages.scrollTop=messages.scrollHeight;
  });

  /* PRIVATE CHAT */
  let privateUser=null;
  let unreadCount=0;
  bellBtn.onclick=()=>{privatePopup.style.display="block";unreadCount=0;updateBadge();}
  function updateBadge(){bellBadge.style.display=unreadCount>0?"block":"none";bellBadge.textContent=unreadCount;}

  openPrivate?.addEventListener("click",()=>{
    privateUser=prompt("Private chat with?");
    if(!privateUser) return;
    privateTitle.textContent=privateUser;
    privatePopup.style.display="block";
    loadPrivate();
  });
  closePrivate.onclick=()=>privatePopup.style.display="none";

  function chatId(a,b){return [a,b].sort().join("_");}
  function loadPrivate(){
    privateMessages.innerHTML="";
    db.ref("private/"+chatId(username,privateUser)).limitToLast(50).on("child_added",s=>{
      privateMessages.innerHTML+=`<div class="msg"><b>${s.val().u}:</b> ${s.val().m}</div>`;
      privateMessages.scrollTop=privateMessages.scrollHeight;
      if(s.val().u!==username){unreadCount++;updateBadge();}
    });
  }

  /* BLOCK/UNBLOCK */
  blockBtn.onclick=()=>{
    const ref=db.ref(`blocks/${privateUser}/${username}`);
    ref.once("value",s=>{
      if(s.exists()){ref.remove();alert("User unblocked")}
      else{ref.set(true);alert("User blocked")}
    });
  };

  /* SEND PRIVATE MESSAGE */
  privateSend.onclick=()=>{
    db.ref(`blocks/${privateUser}/${username}`).once("value",b=>{
      if(b.exists()) return alert("You blocked this user");
      db.ref(`blocks/${username}/${privateUser}`).once("value",bb=>{
        if(bb.exists()) return alert("You are blocked");
        db.ref("private/"+chatId(username,privateUser))
          .push({u:username,m:privateInput.value});
        privateInput.value="";
      });
    });
  };

  /* ===================== */
  /* üîä AUDIO CALL WEBRTC */
  let pc,localStream,activeCall,timer;
  const rtc={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

  callBtn.onclick=()=>startCall(privateUser);

  async function startCall(other){
    const callId=chatId(username,other)+"_"+Date.now();
    activeCall={callId,other};
    localStream=await navigator.mediaDevices.getUserMedia({audio:true});
    pc=new RTCPeerConnection(rtc);
    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    pc.ontrack=e=>remoteAudio.srcObject=e.streams[0];
    pc.onicecandidate=e=>{
      if(e.candidate) db.ref(`calls/${callId}/ice/${username}`).push(e.candidate);
    };
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    db.ref("calls/"+callId).set({from:username,to:other,status:"ringing",offer});
    listenICE(callId);
  }

  db.ref("calls").on("child_added",s=>{
    const c=s.val();
    if(c&&c.to===username&&c.status==="ringing"){
      activeCall={callId:s.key,other:c.from,offer:c.offer};
      callFrom.textContent=c.from;
      callOverlay.style.display="flex";
    }
  });

  acceptCallBtn.onclick=async()=>{
    const {callId,offer}=activeCall;
    localStream=await navigator.mediaDevices.getUserMedia({audio:true});
    pc=new RTCPeerConnection(rtc);
    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    pc.ontrack=e=>remoteAudio.srcObject=e.streams[0];
    pc.onicecandidate=e=>{
      if(e.candidate) db.ref(`calls/${callId}/ice/${username}`).push(e.candidate);
    };
    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer=await pc.createAnswer();
    await pc.setLocalDescription(answer);
    db.ref("calls/"+callId).update({status:"answered",answer});
    listenICE(callId);
    startUI();
  };

  db.ref("calls").on("child_changed",async s=>{
    const c=s.val();
    if(activeCall&&s.key===activeCall.callId&&c.answer){
      await pc.setRemoteDescription(new RTCSessionDescription(c.answer));
      startUI();
    }
    if(c.status==="ended") cleanup();
  });

  function listenICE(id){
    db.ref("calls/"+id+"/ice").on("child_added",s=>{
      s.forEach(c=>pc.addIceCandidate(new RTCIceCandidate(c.val())));
    });
  }

  function startUI(){
    callOverlay.style.display="none";
    inCallBar.style.display="flex";
    inCallWith.textContent=activeCall.other;
    let start=Date.now();
    timer=setInterval(()=>{
      let d=Date.now()-start;
      inCallElapsed.textContent=
        String(d/60000|0).padStart(2,"0")+":"+
        String(d/1000%60|0).padStart(2,"0");
    },1000);
  }
  function cleanup(){
    if(pc) pc.close();
    if(localStream) localStream.getTracks().forEach(t=>t.stop());
    clearInterval(timer);
    callOverlay.style.display="none";
    inCallBar.style.display="none";
    activeCall=null;
  }
  declineCallBtn.onclick=cleanup;
  endCallBtn.onclick=()=>db.ref("calls/"+activeCall.callId+"/status").set("ended");

  /* SETTINGS PANEL TOGGLE */
  settingsBtn.onclick=()=>settingsPanel.style.display=(settingsPanel.style.display==="none"?"block":"none");
}
</script>
</body>
</html>
